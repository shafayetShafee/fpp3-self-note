{
  "hash": "8ece1086c1ada3102632ece605c51bf9",
  "result": {
    "engine": "knitr",
    "markdown": "# GAMS for Time Series\n\n> Disclaimer: The original source of the following contents is [here](https://asbates.rbind.io/2019/05/03/gams-for-time-series/)\n\n\n## Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(mgcv)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_set(theme_bw())\n\nflu <- read_csv(\"https://raw.githubusercontent.com/asbates/nonlinear-models/master/data/ilinet-calif-up-to-2019-03-31.csv\") %>% \n  mutate(t = 1:nrow(.))\n\nflu\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 444 × 8\n   week_start  year  week unweighted_ili ilitotal num_of_providers\n   <date>     <dbl> <dbl>          <dbl>    <dbl>            <dbl>\n 1 2010-10-03  2010    40           1.95      632              112\n 2 2010-10-10  2010    41           2.15      742              122\n 3 2010-10-17  2010    42           2.24      766              126\n 4 2010-10-24  2010    43           1.92      666              130\n 5 2010-10-31  2010    44           2.52      887              131\n 6 2010-11-07  2010    45           2.75      906              126\n 7 2010-11-14  2010    46           2.82     1020              131\n 8 2010-11-21  2010    47           3.16      729              134\n 9 2010-11-28  2010    48           2.61      939              135\n10 2010-12-05  2010    49           3.06     1072              135\n# ℹ 434 more rows\n# ℹ 2 more variables: total_patients <dbl>, t <int>\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nflu_train <- flu %>% filter(week_start < \"2019-01-01\")\nflu_test <- flu %>% filter(week_start >= \"2019-01-01\")\n```\n:::\n\n\n\n## Baseline Model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nold_model <- gam(ilitotal ~ s(week) + s(year), data = flu_train)\n\nflu_train %>% \n  mutate(\n    fitted_gam = predict(old_model)\n  ) %>% \n  ggplot(aes(week_start, ilitotal)) +\n  geom_line() +\n  geom_line(aes(y = fitted_gam, color = \"Fitted GAM\")) +\n  scale_color_discrete(name = \"model\")\n```\n\n::: {.cell-output-display}\n![](gams-for-time-series_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n## Different Basis Functions\n\n$$\ny = f_{trend}(x_1) + f_{seasonal}(x_2)\n$$\n\n- In GAM, we will use a smooth to account for the trend component of the series and a smooth to account for the seasonal component.\n\n- Since the above data is weekly, we will use week as our seasonal component.\n\n- For trend component, we need to use such variable that captures the overall orders of the trend. We will use the UTC value of the time.\n\n- We will fit two models, one with the default \"Thin Plate\" spline for trend comp and another with the \"Gaussian Process\" spline for the trend comp.\n\n- To model seasonal component, we will use \"Cyclic Cubic Spline\" basis with basis dimension $k = 52$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nflu_train %>% \n  mutate(time = as.numeric(week_start)) -> flu_train\n\nflu_test %>% \n  mutate(time = as.numeric(week_start)) -> flu_test\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntp_cc <- gam(ilitotal ~ s(time) + s(week, bs = 'cc', k = 52), data = flu_train)\ngp_cc <- gam(ilitotal ~ s(time, bs = 'gp') + s(week, bs = 'cc', k = 52), data = flu_train)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nflu_train %>% \n  mutate(\n    fitted_tp_cc = predict(tp_cc),\n    fitted_gp_cc = predict(gp_cc)\n  ) %>% \n  pivot_longer(cols = starts_with(\"fitted\"), names_to = \"model\", values_to = \"value\") %>% \n  ggplot(aes(week_start, ilitotal)) +\n  geom_line() +\n  geom_line(aes(y = value, color = model)) +\n  scale_color_manual(\n    values = c(\"fitted_gp_cc\" = \"springgreen3\", \"fitted_tp_cc\" = \"red2\")\n  )\n```\n\n::: {.cell-output-display}\n![](gams-for-time-series_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nflu_test %>% \n  mutate(\n    pred_tp_cc = predict(tp_cc, newdata = .),\n    pred_gp_cc = predict(gp_cc, newdata = .)\n  ) %>% \n  pivot_longer(cols = starts_with(\"pred\"), names_to = \"model\", values_to = \"value\") %>% \n  ggplot(aes(week_start, ilitotal)) + \n  geom_line() +\n  geom_line(aes(y = value, color = model)) +\n  ylim(0, NA)\n```\n\n::: {.cell-output-display}\n![](gams-for-time-series_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "gams-for-time-series_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}